# Story 5.2: Pre-commit Hooks with Security Scanning

## Status
Draft

## Story
**As a** developer,
**I want** pre-commit hooks that prevent committing secrets and enforce code quality,
**so that** security vulnerabilities and code issues are caught before they enter the repository.

## Acceptance Criteria
1. Pre-commit hooks install automatically on `pnpm install`
2. Gitleaks scans for secrets and blocks commits containing them
3. detect-secrets provides additional secret detection
4. Hooks run linting on staged files only (fast feedback)
5. Hooks are skippable with `--no-verify` for emergencies
6. Documentation explains how to set up and use hooks

## Tasks / Subtasks

- [ ] **Task 1: Configure Pre-commit Framework** (AC: 1, 5)
  - [ ] Create `.pre-commit-config.yaml`
  - [ ] Add husky hooks for pnpm integration
  - [ ] Configure pre-commit to run on commit

- [ ] **Task 2: Add Secret Detection** (AC: 2, 3)
  - [ ] Add gitleaks hook configuration
  - [ ] Add detect-secrets hook configuration
  - [ ] Create `.gitleaks.toml` for custom rules if needed
  - [ ] Create `.secrets.baseline` for detect-secrets

- [ ] **Task 3: Add Linting Hooks** (AC: 4)
  - [ ] Add ESLint hook for staged JS/TS files
  - [ ] Add Ruff hook for staged Python files
  - [ ] Configure lint-staged for efficiency

- [ ] **Task 4: Documentation** (AC: 6)
  - [ ] Update README with pre-commit setup instructions
  - [ ] Document how to skip hooks in emergencies
  - [ ] Document how to update hooks

## Dev Notes

### Pre-commit Config Structure
```yaml
# .pre-commit-config.yaml
repos:
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.18.0
    hooks:
      - id: gitleaks
  - repo: https://github.com/Yelp/detect-secrets
    rev: v1.4.0
    hooks:
      - id: detect-secrets
        args: ['--baseline', '.secrets.baseline']
  - repo: local
    hooks:
      - id: lint-staged
        ...
```

### Husky Integration
```json
// package.json
{
  "scripts": {
    "prepare": "husky install"
  }
}
```

### References
- PRD NFR33: Pre-commit hooks shall prevent commits containing secrets
- PRD E0-S4: Set up security scanning

## Testing

### Verification
1. Try committing a file with "password=secret123" - should be blocked
2. Try committing a file with AWS key pattern - should be blocked
3. Try committing code with lint errors - should show warnings
4. Verify hooks run quickly (< 5 seconds on small changes)
5. Verify `--no-verify` bypasses hooks

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 0.1 | Initial story draft | Claude Opus 4.5 |

## Dev Agent Record

### Agent Model Used
(To be filled during implementation)

### Debug Log References
- N/A

### Completion Notes List
(To be filled during implementation)

### File List
**To Create:**
- .pre-commit-config.yaml
- .gitleaks.toml
- .secrets.baseline
- .husky/pre-commit

**To Modify:**
- package.json (add prepare script)
- README.md (add setup instructions)

## QA Results
(To be filled after implementation)
