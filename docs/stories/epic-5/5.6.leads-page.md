# Story 5.6: Leads Management Page

## Status
Ready for Review

## Story
**As a** user,
**I want** a leads management page to track and update lead statuses,
**so that** I can manage my sales pipeline and track conversion outcomes.

## Acceptance Criteria
1. Leads page displays at `/leads` route
2. Leads are displayed in a filterable, sortable table with pagination
3. User can filter leads by status, source, and date range
4. User can update lead status (New → Contacted → Responded → Converted → Lost)
5. User can update lead accuracy (Verified, Bounced, Invalid, Wrong Person)
6. Status changes are recorded with timestamps (audit trail)
7. Leads are scoped to active client profile
8. Pagination controls allow navigating large result sets (API already supports skip/limit)

## Tasks / Subtasks

- [x] **Task 1: Create Leads Page Layout** (AC: 1, 2, 7)
  - [x] Create `apps/web/app/(dashboard)/leads/page.tsx`
  - [x] Add page header with lead count
  - [x] Create leads data table with columns
  - [x] Display active client context

- [x] **Task 2: Implement Filtering** (AC: 3)
  - [x] Add status filter dropdown (All, New, Contacted, etc.)
  - [x] Add source filter dropdown
  - [x] Add date range picker
  - [x] Add search by name/company

- [x] **Task 3: Implement Sorting** (AC: 2)
  - [x] Add sortable column headers
  - [x] Support sorting by: score, status, created date, company
  - [x] Remember sort preference

- [x] **Task 4: Implement Status Update** (AC: 4, 6)
  - [x] Create status dropdown in each row
  - [x] Call API to update status on change
  - [x] Show optimistic update with loading state
  - [x] Display status history on hover/click

- [x] **Task 5: Implement Accuracy Update** (AC: 5)
  - [x] Create accuracy indicator/dropdown
  - [x] Support: Verified, Email Bounced, Phone Invalid, Wrong Person, Company Mismatch
  - [x] Visual indicators for accuracy issues

- [x] **Task 6: Create Leads Store** (AC: 2-6)
  - [x] Create `apps/web/stores/leads-store.ts`
  - [x] Manage leads list with filtering/sorting
  - [x] Handle status and accuracy updates
  - [x] Support pagination

## Dev Notes

### Component Structure
```
apps/web/
├── app/(dashboard)/leads/
│   └── page.tsx
├── components/leads/
│   ├── leads-table.tsx
│   ├── leads-filters.tsx
│   ├── lead-row.tsx
│   ├── status-dropdown.tsx
│   ├── accuracy-badge.tsx
│   └── status-history.tsx
└── stores/
    └── leads-store.ts
```

### API Endpoints
- GET `/v1/leads` - List leads with filters (supports skip, limit, status, search_id params)
- GET `/v1/leads/{id}` - Get lead details with history
- PATCH `/v1/leads/{id}` - Update lead status/accuracy

Note: Pagination is already implemented in the API with skip/limit query parameters.

### Lead Status Flow
```
New → Contacted → Responded → Converted
                           ↘ Lost
```

### Accuracy Values
- `verified` - Contact info confirmed working
- `email_bounced` - Email bounced back
- `phone_invalid` - Phone number doesn't work
- `wrong_person` - Reached wrong contact
- `company_mismatch` - Company info was incorrect

### References
- PRD FR42-FR46: Lead Tracking & Lifecycle
- PRD FR44-FR45: Accuracy tracking
- Data Model: Lead entity with status, accuracy, LeadStatusHistory

## Testing

### Verification
1. Navigate to /leads and verify page loads
2. Filter by status and verify results update
3. Sort by score and verify order
4. Update status and verify change persists
5. Update accuracy and verify indicator shows
6. View status history for a lead

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 0.1 | Initial story draft | Claude Opus 4.5 |
| 2026-01-18 | 1.0 | Implementation complete | Claude Opus 4.5 |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- N/A

### Completion Notes List
- Created leads page at /leads route with filtering, sorting, pagination
- LeadsTable with sortable columns (score, status, created_at, company)
- LeadsFilters with search, status, source, and date range filters
- StatusDropdown for inline status updates (New→Contacted→Responded→Converted/Lost)
- AccuracyBadge for accuracy indicators (verified, bounced, invalid, etc.)
- StatusHistory component to display audit trail
- LeadRow with optimistic updates and history toggle
- leads-store.ts with Zustand for state management
- Pagination via skip/limit API params
- Dashboard layout already had /leads nav link
- Build passes with /leads route properly registered

### File List
**Created:**
- apps/web/app/(dashboard)/leads/page.tsx
- apps/web/components/leads/leads-table.tsx
- apps/web/components/leads/leads-filters.tsx
- apps/web/components/leads/lead-row.tsx
- apps/web/components/leads/status-dropdown.tsx
- apps/web/components/leads/accuracy-badge.tsx
- apps/web/components/leads/status-history.tsx
- apps/web/components/leads/index.ts
- apps/web/stores/leads-store.ts

**Pre-existing (verified):**
- apps/web/app/(dashboard)/layout.tsx (/leads already in nav)

## QA Results

### Gate Decision: **PASS** ✅
**Reviewed by:** Quinn (QA Agent) | **Date:** 2026-01-18 | **Confidence:** HIGH

### Acceptance Criteria Verification

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | /leads route | ✅ PASS | page.tsx created, build confirms route |
| 2 | Filterable/sortable table | ✅ PASS | LeadsTable with columns, pagination |
| 3 | Filters (status, source, date) | ✅ PASS | LeadsFilters with all filter types |
| 4 | Status updates | ✅ PASS | StatusDropdown, updateLeadStatus |
| 5 | Accuracy updates | ✅ PASS | AccuracyBadge with all accuracy types |
| 6 | Audit trail | ✅ PASS | StatusHistory shows transitions |
| 7 | Scoped to profile | ✅ PASS | client_profile_id in API calls |
| 8 | Pagination | ✅ PASS | skip/limit params, Previous/Next buttons |

### Best Practices Assessment
- ✅ Clean component separation
- ✅ Zustand store with proper state management
- ✅ Optimistic updates with rollback
- ✅ Type-safe interfaces
- ✅ Graceful handling when no active profile

### Recommendations
1. **LOW:** Extract fetchWithAuth to shared lib/api.ts
2. **LOW:** Add debounce (300ms) for search queries
3. **MEDIUM:** Fetch distinct sources from API separately

### Risk Assessment: LOW
- Standard CRUD frontend with well-established patterns
- All AC satisfied
- TypeScript provides type safety

**Gate file:** `docs/qa/gates/e5-s6-leads-page.yml`
