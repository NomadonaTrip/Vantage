# Story 5.8: Increase Test Coverage to 70%

## Status
Draft

## Story
**As a** developer,
**I want** comprehensive test coverage across the codebase,
**so that** regressions are caught early and code quality is maintained.

## Acceptance Criteria
1. Overall test coverage reaches 70% for both frontend and backend
2. Critical paths (auth, search, leads) have 80%+ coverage
3. Coverage reports are generated on every CI run
4. Coverage badges are displayed in README
5. New code must maintain coverage threshold (no regression)
6. Coverage reports identify untested critical code paths

## Tasks / Subtasks

- [ ] **Task 1: Audit Current Coverage** (AC: 6)
  - [ ] Run coverage report for apps/api
  - [ ] Run coverage report for apps/web
  - [ ] Identify critical untested modules
  - [ ] Prioritize by risk/importance

- [ ] **Task 2: Add API Tests** (AC: 1, 2)
  - [ ] Add tests for auth routes (login, register, refresh)
  - [ ] Add tests for client profile routes
  - [ ] Add tests for leads routes
  - [ ] Add tests for search routes
  - [ ] Add tests for analytics routes
  - [ ] Add tests for scoring engine

- [ ] **Task 3: Add Frontend Tests** (AC: 1, 2)
  - [ ] Add tests for auth store
  - [ ] Add tests for client store
  - [ ] Add tests for key components (ClientForm, LeadCard)
  - [ ] Add tests for API client functions

- [ ] **Task 4: Configure Coverage in CI** (AC: 3, 5)
  - [ ] Add coverage threshold to pytest config
  - [ ] Add coverage threshold to vitest config
  - [ ] Fail CI if coverage drops below threshold
  - [ ] Upload coverage reports as artifacts

- [ ] **Task 5: Add Coverage Badges** (AC: 4)
  - [ ] Generate coverage badge for API
  - [ ] Generate coverage badge for Web
  - [ ] Add badges to README

## Dev Notes

### Current Coverage (Baseline)
- API: 27% (as of E4 completion)
- Web: Unknown (vitest configured but limited tests)

### Priority Modules for Testing

**API (High Priority):**
- `src/api/routes/auth.py` - Authentication flows
- `src/api/routes/leads.py` - Lead CRUD operations
- `src/api/routes/searches.py` - Search initiation
- `src/services/scoring/engine.py` - Intent scoring logic
- `src/services/orchestrator.py` - Search orchestration

**Web (High Priority):**
- `stores/auth-store.ts` - Auth state management
- `stores/client-store.ts` - Client profile state
- `lib/api-client.ts` - API request handling
- `components/client/client-form.tsx` - Form validation

### Coverage Configuration

**pytest (apps/api/pyproject.toml):**
```toml
[tool.pytest.ini_options]
addopts = "--cov=src --cov-report=html --cov-fail-under=70"
```

**vitest (apps/web/vitest.config.ts):**
```typescript
coverage: {
  provider: 'v8',
  reporter: ['text', 'html'],
  thresholds: {
    global: {
      lines: 70,
      branches: 70,
    }
  }
}
```

### References
- PRD Testing Requirements: Unit + Integration tests
- Current test files: apps/api/tests/, apps/web/tests/

## Testing

### Verification
1. Run `pytest --cov` and verify 70%+ coverage
2. Run `vitest --coverage` and verify 70%+ coverage
3. Push PR and verify coverage reports in CI
4. Remove a test and verify CI fails on coverage drop
5. Verify badges update in README

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 0.1 | Initial story draft | Claude Opus 4.5 |

## Dev Agent Record

### Agent Model Used
(To be filled during implementation)

### Debug Log References
- N/A

### Completion Notes List
(To be filled during implementation)

### File List
**To Create:**
- apps/api/tests/routes/test_auth.py
- apps/api/tests/routes/test_leads.py
- apps/api/tests/routes/test_searches.py
- apps/api/tests/services/test_scoring.py
- apps/web/tests/stores/auth-store.test.ts
- apps/web/tests/stores/client-store.test.ts
- apps/web/tests/components/client-form.test.tsx

**To Modify:**
- apps/api/pyproject.toml (coverage config)
- apps/web/vitest.config.ts (coverage config)
- .github/workflows/ci.yml (coverage upload)
- README.md (coverage badges)

## QA Results
(To be filled after implementation)
