# Story 5.7: Lighthouse CI Accessibility Checks

## Status
Draft

## Story
**As a** developer,
**I want** Lighthouse CI to enforce accessibility standards on every PR,
**so that** the application maintains WCAG 2.1 Level AA compliance.

## Acceptance Criteria
1. Lighthouse CI runs on every PR to main/master
2. Accessibility score must be ≥ 90% to pass
3. Performance score is reported but doesn't block
4. Results are visible in PR comments
5. Failed accessibility checks block merge
6. Configuration allows customizing thresholds

## Tasks / Subtasks

- [ ] **Task 1: Install Lighthouse CI** (AC: 1)
  - [ ] Add @lhci/cli to devDependencies
  - [ ] Create `lighthouserc.js` configuration file

- [ ] **Task 2: Configure Lighthouse Thresholds** (AC: 2, 3, 6)
  - [ ] Set accessibility assertion to ≥ 0.9
  - [ ] Set performance as informational (no assertion)
  - [ ] Configure SEO and best practices thresholds
  - [ ] Set up URL patterns to test

- [ ] **Task 3: Add to CI Pipeline** (AC: 1, 4, 5)
  - [ ] Add Lighthouse job to `.github/workflows/ci.yml`
  - [ ] Build app before running Lighthouse
  - [ ] Upload results as PR comment
  - [ ] Configure to fail on accessibility < 90%

- [ ] **Task 4: Configure Test URLs** (AC: 2)
  - [ ] Test home page (/)
  - [ ] Test login page (/login)
  - [ ] Test dashboard page (with mock auth)
  - [ ] Document which pages are tested

## Dev Notes

### Lighthouse Configuration
```javascript
// lighthouserc.js
module.exports = {
  ci: {
    collect: {
      startServerCommand: 'pnpm start',
      startServerReadyPattern: 'ready',
      url: [
        'http://localhost:3000/',
        'http://localhost:3000/login',
        'http://localhost:3000/register',
      ],
      numberOfRuns: 3,
    },
    assert: {
      assertions: {
        'categories:accessibility': ['error', { minScore: 0.9 }],
        'categories:performance': ['warn', { minScore: 0.5 }],
        'categories:best-practices': ['warn', { minScore: 0.8 }],
        'categories:seo': ['warn', { minScore: 0.8 }],
      },
    },
    upload: {
      target: 'temporary-public-storage',
    },
  },
};
```

### CI Integration
```yaml
lighthouse:
  runs-on: ubuntu-latest
  needs: [build]
  steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
    - run: pnpm install
    - run: pnpm build
    - run: pnpm lhci autorun
```

### References
- PRD NFR28: WCAG 2.1 Level AA compliance, Lighthouse ≥ 90%
- PRD E0-S6: Set up Lighthouse CI

## Testing

### Verification
1. Run Lighthouse locally with `pnpm lhci autorun`
2. Verify accessibility score meets threshold
3. Create PR and verify Lighthouse runs in CI
4. Introduce accessibility issue and verify CI fails
5. Verify results appear in PR comments

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 0.1 | Initial story draft | Claude Opus 4.5 |

## Dev Agent Record

### Agent Model Used
(To be filled during implementation)

### Debug Log References
- N/A

### Completion Notes List
(To be filled during implementation)

### File List
**To Create:**
- lighthouserc.js
- Update .github/workflows/ci.yml (add lighthouse job)

**To Modify:**
- apps/web/package.json (add @lhci/cli)

## QA Results
(To be filled after implementation)
