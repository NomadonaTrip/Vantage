# Story 5.5: Search Page Frontend

## Status
Ready for Review

## Story
**As a** user,
**I want** a search page to generate leads for my client profiles,
**so that** I can discover potential customers matching my ideal customer profile.

## Acceptance Criteria
1. Search page displays at `/search` route
2. User can initiate search using active client profile context
3. Manual override panel allows specifying custom search parameters
4. Progress shows sources being queried and leads found (via polling GET /searches/{id})
5. Search can be cancelled mid-progress via POST /searches/{id}/cancel, returning partial results
6. Results display ranked leads with intent scores
7. Quality slider (0-1) controls speed vs quality trade-off
8. Error states display user-friendly messages with retry option

## Tasks / Subtasks

- [x] **Task 1: Create Search Page Layout** (AC: 1, 7)
  - [x] Create `apps/web/app/(dashboard)/search/page.tsx`
  - [x] Add search header with active client context
  - [x] Add quality slider component
  - [x] Add "Start Search" button

- [x] **Task 2: Create Manual Override Panel** (AC: 3)
  - [x] Create collapsible manual override section
  - [x] Add keyword input field
  - [x] Add location filter
  - [x] Add company size filter
  - [x] Add budget range filter
  - [x] Add "Supplement" vs "Replace" toggle

- [x] **Task 3: Implement Search Progress** (AC: 4, 5)
  - [x] Create search progress component
  - [x] Display sources being queried (pending/success/failed)
  - [x] Display leads found counter
  - [x] Display overall percentage progress
  - [x] Add cancel button during search

- [x] **Task 4: Implement Results Display** (AC: 6)
  - [x] Create lead result card component
  - [x] Display name, company, email, phone
  - [x] Display intent score with breakdown tooltip
  - [x] Display source with link
  - [x] Add CSV export button

- [x] **Task 5: Create Search Store** (AC: 2, 4, 5, 8)
  - [x] Create `apps/web/stores/search-store.ts`
  - [x] Manage search state (idle, searching, completed, cancelled, error)
  - [x] Integrate with search API endpoints
  - [x] Implement polling mechanism (1-2 second intervals) for progress updates
  - [x] Handle error states with user-friendly messages

## Dev Notes

### Component Structure
```
apps/web/
├── app/(dashboard)/search/
│   └── page.tsx
├── components/search/
│   ├── search-header.tsx
│   ├── manual-override.tsx
│   ├── search-progress.tsx
│   ├── search-results.tsx
│   ├── lead-card.tsx
│   └── quality-slider.tsx
└── stores/
    └── search-store.ts
```

### API Endpoints
- POST `/v1/searches` - Start new search
- GET `/v1/searches` - List searches
- GET `/v1/searches/{id}` - Get search status/results (poll this for progress)
- POST `/v1/searches/{id}/cancel` - Cancel search

Note: WebSocket is not currently implemented. Use polling (1-2 second intervals) on GET /searches/{id} to check progress.

### Manual Override Schema
```typescript
interface ManualOverride {
  mode: 'supplement' | 'replace';
  keywords?: string;
  location?: string;
  companySize?: 'solo' | 'small' | 'medium' | 'enterprise';
  budgetMin?: number;
  budgetMax?: number;
  industry?: string;
}
```

### References
- PRD FR33-FR37: Manual Search Mode
- PRD FR54: Real-time search progress via WebSocket
- PRD FR56: Search cancellation
- PRD FR30-FR32: Quality control slider

## Testing

### Verification
1. Navigate to /search and verify page loads
2. Start search and verify progress updates
3. Cancel search and verify partial results returned
4. Use manual override and verify parameters applied
5. Verify quality slider affects search behavior
6. Export results to CSV and verify format

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 0.1 | Initial story draft | Claude Opus 4.5 |
| 2026-01-18 | 1.0 | Implementation complete | Claude Opus 4.5 |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References
- N/A

### Completion Notes List
- Created search page at /search route with all components
- Implemented Zustand search-store with polling (1.5s intervals)
- SearchHeader component displays active client profile context and quality slider
- ManualOverride component is collapsible with supplement/replace mode toggle
- SearchProgress component shows sources status and cancel button
- SearchResults component displays leads sorted by intent score with CSV export
- LeadCard component shows contact info and intent score with breakdown tooltip
- QualitySlider component ranges 0-1 with Fast/Balanced/Thorough labels
- Dashboard layout already had /search nav link
- Build passes with /search route properly registered

### File List
**Created:**
- apps/web/app/(dashboard)/search/page.tsx
- apps/web/components/search/search-header.tsx
- apps/web/components/search/manual-override.tsx
- apps/web/components/search/search-progress.tsx
- apps/web/components/search/search-results.tsx
- apps/web/components/search/lead-card.tsx
- apps/web/components/search/quality-slider.tsx
- apps/web/components/search/index.ts
- apps/web/stores/search-store.ts

**Pre-existing (verified):**
- apps/web/app/(dashboard)/layout.tsx (/search already in nav)

## QA Results

### Gate Decision: **PASS** ✅
**Reviewed by:** Quinn (QA Agent) | **Date:** 2026-01-18 | **Confidence:** HIGH

### Acceptance Criteria Verification

| AC | Description | Status | Evidence |
|----|-------------|--------|----------|
| 1 | /search route | ✅ PASS | page.tsx created, build confirms route |
| 2 | Active client context | ✅ PASS | SearchHeader displays profile, startSearch uses profile.id |
| 3 | Manual override panel | ✅ PASS | Collapsible panel with all fields and mode toggle |
| 4 | Progress with polling | ✅ PASS | SearchProgress shows sources, 1.5s polling interval |
| 5 | Cancel search | ✅ PASS | POST /cancel endpoint, partial results returned |
| 6 | Ranked leads with scores | ✅ PASS | LeadCard with score tooltip, sorted by intent |
| 7 | Quality slider | ✅ PASS | 0-1 range with Fast/Balanced/Thorough labels |
| 8 | Error states with retry | ✅ PASS | Error display with retry button |

### Best Practices Assessment
- ✅ Clean component separation
- ✅ Zustand store with proper state management
- ✅ Polling cleanup on unmount
- ✅ Type-safe interfaces
- ✅ CSV export functionality
- ✅ Graceful handling when no active profile

### Recommendations
1. **LOW:** Extract fetchWithAuth to shared lib/api.ts utility
2. **LOW:** Add loading skeleton during initial profile fetch
3. **MEDIUM:** Add retry limit and backoff strategy for polling errors

### Risk Assessment: LOW
- Standard CRUD frontend with well-established patterns
- All AC satisfied
- TypeScript provides type safety

**Gate file:** `docs/qa/gates/e5-s5-search-page.yml`
